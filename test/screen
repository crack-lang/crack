#!/bin/sh
# Copyright 2011 Google Inc.
# Runs the "screen" command on selected tests or the set of all tests.
# Options:
#   -n run tests under llvm-native
#   -f stop on fail
#   -r recompile the screen program
#   -j run screen in JIT mode
#   -v turn on verbose output

root="$(dirname $(dirname $0))"

builders="-bjit"
opts=""
screen_jit=false
screen_recompile=false
export CRACK_LIB_PATH=$root/.libs

run_screen() {
    if $screen_jit; then
        $root/crack -l "$root/lib:$root/screen" $root/screen/screen.crk \
            -c "$root/crack" -s "$root" -o "$root/screen/output" "$builders" \
            $opts "$@"
        return
    fi

    if $screen_recompile || [ ! -e $root/test/screen.bin ]; then
        echo "rebuilding screen.bin..."
        $root/crack -B llvm-native -l "$root/lib:$root/screen" \
            -b out=$root/test/screen.bin $root/screen/screen.crk
    fi
    
    $root/test/screen.bin -c "$root/crack" -s "$root" \
        -o "$root/screen/output" "$builders" $opts "$@"
}

args=$(getopt fnrjv "$@")
eval set -- "$args"

# process options
while true; do
    
    case "$1" in
        -n) builders='-bnative' ;;
        -f) opts="$opts --stop-on-fail" ;;
        -r) screen_recompile=true ;;
        -j) screen_jit=true ;;
        -v) opts="$opts -v" ;;
        --) shift ; break ;;
    esac
    
    shift
done

# ensure output directory exits
if [ ! -e "$root/screen/output" ]; then
    mkdir "$root/screen/output"
fi

tests=""
for arg in "$@"; do
    tests="$tests -f $arg"
done

if [ -n "$tests" ]; then
    run_screen $tests
else
    run_screen -d "$root/screen/tests/basic"
fi

exit $?
