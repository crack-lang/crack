# Copyright 2010 Google Inc.
# Extension tests.

import testext echo, copyArray, MyType, INT_CONST, FLOAT_CONST,
               callback,
               MyVirtual;
import crack.io cout;
if (String(echo("hello".buffer)) != "hello")
    cout `failed on function invocation\n`;

t := MyType();
if (String(t.echo('bite me'.buffer)) != 'bite me') 
    cout `failed on method invocation\n`;

if (t.a != 100)
    cout `integer instance variable not set.\n`;

if (String(t.b) != 'test')
    cout `string instance variable not set.\n`;

MyType u;
if (!(u is null))
    cout `null test fails\n`;

class MyAggType : Object, MyType {
    oper init() {}
    oper init(int a, byteptr b) : MyType(a, b) {}
}

agg := MyAggType();
if (agg.refCount != 1)
    cout `bad reference count in MyAggType\n`;
if (agg.a != 0)
    cout `Instance variable "a" not initialized in MyAggType\n`;

agg = MyAggType(100, null);
if (agg.refCount != 1)
    cout `bad reference count in MyAggType(100)\n`;
if (agg.a != 100)
    cout `Instance variable "a" not initialized in MyAggType(100)\n`;

if (INT_CONST != 123)
    cout `Constant $(INT_CONST) != 123\n`;

if (FLOAT_CONST != 1.23)
    cout `Constant $(FLOAT_CONST) != 1.23\n`;

arr := array[int](10);
for (int i = 0; i < 10; ++i)
    arr[uint(i)] = i;
arr2 := copyArray(10, arr);
for (int i = 0; i < 10; ++i)
    if (arr2[uint(i)] != i)
        cout `Type specialization failed: arr2[$i] != $i\n`;

int myCallBack(int x) {
    // value of 100 is specified in textext.cc
    if (x != 100)
        cout `callback param fail\n`;
    return 50;
}

r := callback(myCallBack);
if (r != 50)
    cout `callback return fail\n`;

# verify that we call the C++ function without an override
v := MyVirtual();
if (v.vfunc(100) != 100)
    cout `FAILED calling C++ virtual\n`;
v.oper del();

class DerivedVirtual : MyVirtual {
    array[int] flags;
    oper init(array[int] flags) : flags = flags {}
    int vfunc(int val) {
        return val + 1;
    }
    
    oper del() {
        flags[0] = 666;
    }
}

# verify that we call the derived function from the crack side
array[int] flags = [0];
v = DerivedVirtual(flags);
if (v.vfunc(100) != 101)
    cout `FAILED overridind C++ virtual\n`;
v.oper del();
if (flags[0] != 666)
    cout `FAILED overriding destructor\n`;

flags[0] = 0;
MyVirtual(flags).oper del();
if (flags[0] != 999)
    cout `FAILED calling virtual destructor.`;

cout `ok\n`;
